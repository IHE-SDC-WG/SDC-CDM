#!meta

{"kernelInfo":{"defaultKernelName":"csharp","items":[{"name":"csharp","languageName":"C#","aliases":["c#","cs"]},{"name":"fsharp","languageName":"F#","aliases":["f#","fs"]},{"name":"html","languageName":"HTML"},{"name":"http","languageName":"HTTP"},{"name":"javascript","languageName":"JavaScript","aliases":["js"]},{"name":"kql","languageName":"KQL"},{"name":"mermaid","languageName":"Mermaid"},{"name":"pwsh","languageName":"PowerShell","aliases":["powershell"]},{"name":"sql","languageName":"SQL"},{"name":"sql-ecpdb","languageName":"SQLite"},{"name":"value"}]}}

#!markdown

# OMOP SDC MVP - Interactive Testing Notebook

This notebook provides an interactive way to test the OMOP SDC MVP implementation for importing Elective Case Pre-Adjudication (ECP) data from NAACCR V2 CPR messages into the OMOP Common Data Model (CDM) v5.4.

## Overview

This notebook will:
1. **Build the SDC CDM libraries**
2. **Create a test database** with the extended OMOP schema
3. **Import sample NAACCR V2 data** (Adrenal gland pathology report)
4. **Validate the import** by querying the data
5. **Demonstrate query capabilities** for both standard OMOP and SDC-specific fields
6. **Provide comprehensive testing** across 11 validation steps

## Prerequisites

- .NET 8.0 SDK installed
- Polyglot Notebooks extension in VS Code
- Sample data files available in the repository

---

**Note**: This notebook is designed for testing and validation purposes. The database file (`test_ecp.db`) will be created in the current directory and is automatically ignored by Git.

#!pwsh

# Build the SDC CDM libraries
Write-Host "Building SDC CDM libraries..." -ForegroundColor Green
dotnet build ../SdcCdmLib
Write-Host "Build completed!" -ForegroundColor Green

#!csharp

// Reference external libraries and the SDC CDM library assembly
#r "nuget:Microsoft.Data.Sqlite,9.0.0"
#r "nuget:Microsoft.Extensions.Logging.Console,9.0.4"
#r "nuget:Microsoft.DotNet.Interactive.SqlServer,1.0.0-beta.25323.1"
#r "nuget:Microsoft.DotNet.Interactive.Sqlite,1.0.0-beta.25323.1"
#r "../SdcCdmLib/SdcCdm/bin/Debug/net8.0/SdcCdm.dll"
#r "../SdcCdmLib/SdcCdmInSqlite/bin/Debug/net8.0/SdcCdmInSqlite.dll"

using SdcCdm;
using System;
using System.IO;
using System.Linq;
using System.Collections.Generic;

Console.WriteLine("Dependencies loaded. SQL kernel enabled.");

#!markdown

## Step 1: Create Test Database

Create a new SQLite database with the extended OMOP schema for testing.

#!csharp

// Create a test database
var dbPath = "test_ecp.db";

// Remove existing database if it exists
if (File.Exists(dbPath))
{
    File.Delete(dbPath);
    Console.WriteLine($"Removed existing database: {dbPath}");
}

// Create new database instance
var sdcCdm = new SdcCdmInSqlite.SdcCdmInSqlite(dbPath, overwrite: true);

// Build the schema (includes extended measurement table and sdc_template_instance_ecp table)
Console.WriteLine("Building database schema...");
sdcCdm.BuildSchema();

Console.WriteLine($"Database created successfully: {Path.GetFullPath(dbPath)}");

#!markdown

## Step 2: Import Sample NAACCR V2 Data

Import the sample Adrenal gland and additional pathology reports to test the ECP data import functionality.

#!csharp

using Microsoft.Data.Sqlite;

// Import specific HL7 files
var hl7Files = new[] {
    "../sample_data/naaccr_v2/obx-Adrenal.hl7",
    "../sample_data/naaccr_v2/24-11-000312-2.txt.hl7",
    "../sample_data/naaccr_v2/CDCECC/117.1000043/3716960.hl7"
};

// Toggle to suppress verbose importer logs (prevents output truncation)
bool quietImporter = false;

string absDbPath = Path.GetFullPath(dbPath);

bool TableExists(SqliteConnection c, string name)
{
    using var cmd = c.CreateCommand();
    cmd.CommandText = "SELECT 1 FROM sqlite_master WHERE type='table' AND name=$name LIMIT 1";
    cmd.Parameters.AddWithValue("$name", name);
    var val = cmd.ExecuteScalar();
    return val != null;
}

int? GetCount(SqliteConnection c, string table)
{
    if (!TableExists(c, table)) return null;
    using var cmd = c.CreateCommand();
    cmd.CommandText = $"SELECT COUNT(*) FROM {table}";
    return Convert.ToInt32(cmd.ExecuteScalar());
}

record ImportSummary(string File, int Size, bool Success, int? RowsAdded, string? Note, string? Error);
var results = new List<ImportSummary>();

foreach (var filePath in hl7Files)
{
    if (!File.Exists(filePath))
    {
        Console.WriteLine($"Sample data file not found: {filePath}");
        Console.Out.Flush();
        results.Add(new ImportSummary(Path.GetFileName(filePath), 0, false, null, null, "File not found"));
        continue;
    }

    SqliteConnection? conn = null;
    string fileName = Path.GetFileName(filePath);
    string? note = null;
    int size = 0;
    try
    {
        Console.WriteLine($"==== BEGIN Import: {fileName} ====");
        Console.Out.Flush();

        var hl7Message = File.ReadAllText(filePath);
        size = hl7Message.Length;
        Console.WriteLine($"File size: {size} characters");
        Console.Out.Flush();

        conn = new SqliteConnection($"Data Source={absDbPath};Cache=Shared");
        conn.Open();
        var beforeCount = GetCount(conn, "measurement");

        var originalOut = Console.Out;
        if (quietImporter)
        {
            Console.SetOut(TextWriter.Null);
        }
        try
        {
            // Import the NAACCR V2 message (this emits its own logs)
            NAACCRVolVImporter.ImportNaaccrVolV(sdcCdm, hl7Message);
        }
        finally
        {
            if (quietImporter)
            {
                Console.SetOut(originalOut);
            }
        }

        var afterCount = GetCount(conn, "measurement");
        if (beforeCount.HasValue && afterCount.HasValue)
        {
            var rowsAdded = afterCount.Value - beforeCount.Value;
            Console.WriteLine($"Import completed successfully! Rows added: {rowsAdded}");
            results.Add(new ImportSummary(fileName, size, true, rowsAdded, null, null));
        }
        else if (afterCount.HasValue)
        {
            Console.WriteLine($"Import completed successfully! measurement rows: {afterCount.Value}");
            note = "Before-count unavailable (table not present before import)";
            results.Add(new ImportSummary(fileName, size, true, null, note, null));
        }
        else
        {
            Console.WriteLine("Import completed. (measurement table not present to compute row counts)");
            note = "measurement table missing";
            results.Add(new ImportSummary(fileName, size, true, null, note, null));
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error during import: {ex.Message}");
        Console.WriteLine($"Stack trace: {ex.StackTrace}");
        results.Add(new ImportSummary(fileName, size, false, null, note, ex.Message));
    }
    finally
    {
        try { conn?.Dispose(); } catch { }
        Console.WriteLine($"==== END Import: {fileName} ====\n");
        Console.Out.Flush();
    }
}

// Print a compact summary so results are visible even if the top is truncated
Console.WriteLine("==== Import Summary ====");
foreach (var r in results)
{
    var status = r.Success ? "OK" : "FAIL";
    var rows = r.RowsAdded.HasValue ? r.RowsAdded.Value.ToString() : (r.Success ? (r.Note ?? "n/a") : "n/a");
    var extra = r.Error != null ? $" | error: {r.Error}" : (r.Note != null ? $" | note: {r.Note}" : string.Empty);
    Console.WriteLine($"- {r.File} | size: {r.Size} | status: {status} | rows: {rows}{extra}");
}
Console.Out.Flush();

#!csharp

#!connect sqlite --kernel-name ecpdb "Data Source=/Users/work/repos/SDC-CDM/notebooks/test_ecp.db;Cache=Shared"

// Connection established to SQLite database file test_ecp.db as kernel 'ecpdb'.

#!markdown

## Step 3: Validate Import - Template Instances

Let's verify that the template instance was created correctly in the `sdc_template_instance_ecp` table.

#!sql-ecpdb

SELECT
  sdc_template_instance_ecp_id AS id,
  template_name,
  template_version,
  template_instance_guid AS guid,
  COALESCE(tumor_site, 'N/A') AS tumor_site,
  COALESCE(procedure_type, 'N/A') AS procedure,
  COALESCE(specimen_laterality, 'N/A') AS laterality,
  COALESCE(report_template_source, 'N/A') AS source,
  created_datetime AS created
FROM sdc_template_instance_ecp
ORDER BY created_datetime DESC;

#!markdown

## Step 4: Validate Import - Measurement Count

Check how many ECP measurements were imported into the extended `measurement` table.

#!sql-ecpdb

SELECT COUNT(*) AS measurement_count
FROM measurement
WHERE sdc_template_instance_guid IS NOT NULL;

#!markdown

## Step 5: Validate Import - Response Types

Analyze the distribution of measurements by response type (numeric, text, list_selection).

#!sql-ecpdb

SELECT sdc_response_type AS response_type,
       COUNT(*) AS count
FROM measurement
WHERE sdc_template_instance_guid IS NOT NULL
GROUP BY sdc_response_type
ORDER BY count DESC;

#!markdown

## Step 6: Sample Measurements

Display sample measurements to verify the SDC-specific columns are populated correctly, showing one of each response type first.

#!sql-ecpdb

-- Ensure first 10 rows include: (a) one per response type present; (b) one per imported file (template instance)
WITH base AS (
  SELECT m.*, ti.template_name, ti.template_version
  FROM measurement m
  LEFT JOIN sdc_template_instance_ecp ti
    ON ti.template_instance_guid = m.sdc_template_instance_guid
  WHERE m.sdc_template_instance_guid IS NOT NULL
),
-- First row for each response type (numeric, text, list_selection) by sdc_order
first_per_type AS (
  SELECT measurement_id, sdc_order, 0 AS subgrp
  FROM (
    SELECT measurement_id,
           sdc_order,
           ROW_NUMBER() OVER (PARTITION BY sdc_response_type ORDER BY sdc_order) AS rn
    FROM base
    WHERE sdc_response_type IN ('list_selection','text','numeric')
  ) t
  WHERE rn = 1
),
-- First row for each imported file (template instance) by sdc_order
first_per_file AS (
  SELECT measurement_id, sdc_order, 1 AS subgrp
  FROM (
    SELECT measurement_id,
           sdc_order,
           ROW_NUMBER() OVER (PARTITION BY sdc_template_instance_guid ORDER BY sdc_order) AS rn
    FROM base
  ) t
  WHERE rn = 1
),
-- Combine and de-duplicate priority picks (types first, then files), cap to 10
priority_union AS (
  SELECT measurement_id, sdc_order, subgrp FROM first_per_type
  UNION
  SELECT measurement_id, sdc_order, subgrp FROM first_per_file
),
priority_limited AS (
  SELECT measurement_id, sdc_order, subgrp
  FROM priority_union
  ORDER BY subgrp, sdc_order
  LIMIT 10
),
-- Compute remaining slots to fill up to 10
slots AS (
  SELECT CASE WHEN 10 - COUNT(*) < 0 THEN 0 ELSE 10 - COUNT(*) END AS remaining
  FROM priority_limited
),
-- Fill any leftover slots (by sdc_order) excluding already chosen priority rows
fill AS (
  SELECT b.measurement_id, b.sdc_order, 2 AS subgrp
  FROM base b, slots
  WHERE b.measurement_id NOT IN (SELECT measurement_id FROM priority_limited)
  ORDER BY b.sdc_order
  LIMIT (SELECT remaining FROM slots)
),
-- Final first-10 set
first_ten AS (
  SELECT measurement_id, 0 AS grp, sdc_order FROM priority_limited
  UNION ALL
  SELECT measurement_id, 0 AS grp, sdc_order FROM fill
),
-- Remaining rows after the first 10
remaining AS (
  SELECT b.measurement_id, 1 AS grp, b.sdc_order
  FROM base b
  WHERE b.measurement_id NOT IN (SELECT measurement_id FROM first_ten)
)
SELECT 
  b.sdc_question_identifier,
  b.sdc_question_text,
  b.sdc_response_value,
  b.sdc_response_type,
  b.sdc_units,
  COALESCE(b."OBX4", 'N/A') AS OBX4,
  substr(b.sdc_template_instance_guid, 1, 8) AS instance,
  COALESCE(b.template_name, '') AS template,
  b.sdc_order
FROM (
  SELECT measurement_id, grp, sdc_order FROM first_ten
  UNION ALL
  SELECT measurement_id, grp, sdc_order FROM remaining
) x
JOIN base b ON b.measurement_id = x.measurement_id
ORDER BY x.grp, x.sdc_order;

#!markdown

## Step 7: OMOP Compliance Validation

Verify that standard OMOP fields are properly populated alongside the SDC-specific data, ensuring every column shows at least one example with actual values.

#!sql-ecpdb

-- Numeric with units
WITH numeric_with_units AS (
  SELECT measurement_id AS id,
         person_id AS person,
         measurement_concept_id AS concept,
         DATE(measurement_date) AS date,
         measurement_type_concept_id AS type,
         value_as_number AS omop_number,
         sdc_response_value AS sdc_value,
         sdc_units AS sdc_units,
         COALESCE("OBX4", 'N/A') AS OBX4,
         sdc_order
  FROM measurement
  WHERE sdc_template_instance_guid IS NOT NULL
    AND value_as_number IS NOT NULL
    AND sdc_units IS NOT NULL AND sdc_units != ''
  ORDER BY sdc_order
  LIMIT 1
),
-- Numeric without units
numeric_without_units AS (
  SELECT measurement_id AS id,
         person_id AS person,
         measurement_concept_id AS concept,
         DATE(measurement_date) AS date,
         measurement_type_concept_id AS type,
         value_as_number AS omop_number,
         sdc_response_value AS sdc_value,
         sdc_units AS sdc_units,
         COALESCE("OBX4", 'N/A') AS OBX4,
         sdc_order
  FROM measurement
  WHERE sdc_template_instance_guid IS NOT NULL
    AND value_as_number IS NOT NULL
    AND (sdc_units IS NULL OR sdc_units = '')
  ORDER BY sdc_order
  LIMIT 1
),

categorical AS (
  SELECT measurement_id AS id,
         person_id AS person,
         measurement_concept_id AS concept,
         DATE(measurement_date) AS date,
         measurement_type_concept_id AS type,
         value_as_number AS omop_number,
         sdc_response_value AS sdc_value,
         sdc_units AS sdc_units,
         COALESCE("OBX4", 'N/A') AS OBX4,
         sdc_order
  FROM measurement
  WHERE sdc_template_instance_guid IS NOT NULL
    AND value_as_number IS NULL
  ORDER BY sdc_order
)
SELECT id, person, concept, date, type, omop_number, sdc_value, sdc_units, OBX4
FROM (
  SELECT * FROM numeric_with_units
  UNION ALL
  SELECT * FROM numeric_without_units
  UNION ALL
  SELECT * FROM categorical
)
ORDER BY sdc_order;

#!markdown

## Step 8: Advanced Query Examples

Demonstrate more complex queries that combine standard OMOP fields with SDC-specific data.

#!sql-ecpdb

SELECT m.sdc_question_identifier AS question_id,
       COALESCE(m.sdc_question_text, 'N/A') AS question_text,
       printf('%.1f', m.value_as_number) AS value,
       COALESCE(m.sdc_units, 'N/A') AS units,
       m.sdc_response_type AS response_type,
       ti.template_name AS template,
       COALESCE(m."OBX4", 'N/A') AS OBX4
FROM measurement m
JOIN sdc_template_instance_ecp ti
  ON m.sdc_template_instance_guid = ti.template_instance_guid
WHERE m.sdc_response_type = 'numeric'
  AND m.value_as_number IS NOT NULL
ORDER BY m.sdc_order;

#!markdown

## Step 9: Template Metadata Analysis

Analyze the template metadata stored in the `sdc_template_instance_ecp` table.

#!sql-ecpdb

SELECT template_name,
       template_version,
       COALESCE(report_template_source, 'N/A') AS source,
       COALESCE(report_template_id, 'N/A') AS id,
       COALESCE(report_template_version_id, 'N/A') AS version_id,
       COALESCE(tumor_site, 'N/A') AS tumor_site,
       COALESCE(procedure_type, 'N/A') AS procedure,
       COALESCE(specimen_laterality, 'N/A') AS laterality
FROM sdc_template_instance_ecp;

#!markdown

## Step 10: Summary and Validation

Provide a summary of the test results and validate that the MVP is working correctly.

#!sql-ecpdb

SELECT 'Template Instances' AS metric, COUNT(*) AS value FROM sdc_template_instance_ecp
UNION ALL
SELECT 'ECP Measurements', COUNT(*) FROM measurement WHERE sdc_template_instance_guid IS NOT NULL
UNION ALL
SELECT 'Person Records', COUNT(*) FROM person
UNION ALL
SELECT 'Concept Records', COUNT(*) FROM concept;

#!markdown

## Step 11: Cleanup (Optional)

If you want to clean up the test database, you can run this cell. The database file is already ignored by Git.

#!csharp

// Optional: Clean up test database
Console.WriteLine("\nTo clean up the test database, uncomment the following lines:");
Console.WriteLine("// if (File.Exists(dbPath))");
Console.WriteLine("// { File.Delete(dbPath); Console.WriteLine($\"Removed database: {dbPath}\"); }");

// Uncomment the lines below if you want to clean up
if (File.Exists(dbPath))
{
    File.Delete(dbPath);
    Console.WriteLine($"Removed database: {dbPath}");
}

Console.WriteLine("\nTest completed! The database file remains for further inspection.");
